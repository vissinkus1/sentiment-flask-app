<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentiment Studio - AI NLP Dashboard</title>

    <!-- Fonts: Outfit + Plus Jakarta Sans -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Bootstrap Grid Only (optional, but keeping full bootstrap for utility if needed) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom Styles -->
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
</head>

<body>
    <!-- Abstract Background Elements -->
    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>

    <div class="app-container">
        <!-- Header -->
        <header class="mb-5 text-center text-lg-start">
            <h1 class="display-title">Sentiment Studio</h1>
            <p class="subtitle">Advanced NLP Analytics with BERT, VADER, and TextBlob</p>
        </header>

        <div class="row g-4">
            <!-- Left Panel: Single Analysis -->
            <div class="col-lg-6">
                <div class="glass-panel h-100">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="h4 mb-0">Single Analysis</h2>
                        <span
                            class="badge bg-dark bg-opacity-50 border border-secondary border-opacity-25 py-2 px-3 rounded-pill text-white-50 small">Live
                            Mode</span>
                    </div>

                    <div class="vstack gap-3">
                        <div>
                            <label for="singleModel"
                                class="form-label text-secondary small text-uppercase fw-bold mb-2">Select Model</label>
                            <select class="form-select" id="singleModel">
                                <option value="bert">BERT Transformer (High Accuracy)</option>
                                <option value="vader">VADER (Social Media Optimized)</option>
                                <option value="textblob">TextBlob (Basic Polarity)</option>
                            </select>
                        </div>

                        <div>
                            <label for="singleText"
                                class="form-label text-secondary small text-uppercase fw-bold mb-2">Input Text</label>
                            <textarea id="singleText" class="form-control"
                                placeholder="Enter text to analyze here... (e.g. 'This product is absolutely amazing!')"></textarea>
                        </div>

                        <div class="mt-2">
                            <button onclick="analyzeSingle()" class="btn-primary-glow w-100">
                                Analyze Sentiment <span class="ms-2">‚ú®</span>
                            </button>
                        </div>
                    </div>

                    <!-- Dynamic Result Area -->
                    <div id="singleResult" class="mt-4"></div>
                </div>
            </div>

            <!-- Right Panel: Batch Analysis -->
            <div class="col-lg-6">
                <div class="glass-panel h-100">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="h4 mb-0">Batch Processing</h2>
                        <span
                            class="badge bg-dark bg-opacity-50 border border-secondary border-opacity-25 py-2 px-3 rounded-pill text-white-50 small">CSV
                            Only</span>
                    </div>

                    <form id="batchForm" onsubmit="analyzeBatch(event)">
                        <div class="mb-3">
                            <label for="batchModel"
                                class="form-label text-secondary small text-uppercase fw-bold mb-2">Select Model</label>
                            <select class="form-select" id="batchModel">
                                <option value="bert">BERT Transformer</option>
                                <option value="vader">VADER</option>
                                <option value="textblob">TextBlob</option>
                            </select>
                        </div>

                        <div class="upload-zone mb-3" id="dropZone">
                            <input type="file" id="csvFile" accept=".csv" required onchange="handleFileSelect(this)">
                            <div class="upload-content">
                                <div class="upload-icon">üìÇ</div>
                                <p class="mb-1 fw-bold">Click to Upload CSV</p>
                                <p class="text-muted small mb-0">or drag and drop file here</p>
                                <p class="text-info small mt-2 fst-italic" id="fileNameDisplay"></p>
                            </div>
                        </div>

                        <button type="submit" class="btn-primary-glow w-100"
                            style="background: linear-gradient(135deg, #10b981 0%, #34d399 100%); box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);">
                            Process Dataset <span class="ms-2">üöÄ</span>
                        </button>
                    </form>

                    <!-- Batch Results Area -->
                    <div id="batchResult" class="mt-4"></div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-5 text-center text-muted small">
            <p>&copy; 2024 Sentiment Studio. Powered by Hugging Face Transformers & Flask.</p>
        </footer>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- App Logic -->
    <script>
        // --- UI Helpers ---
        function handleFileSelect(input) {
            const fileName = input.files[0]?.name || '';
            document.getElementById('fileNameDisplay').textContent = fileName ? `Selected: ${fileName}` : '';
        }

        // --- Logic from previous version (adapted for new UI) ---
        let batchChart = null;
        let latestBatchRows = [];

        function escapeHtml(value) {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function normalizeSentiment(value) {
            const normalized = String(value || '').toLowerCase();
            if (normalized.includes('pos')) return 'positive';
            if (normalized.includes('neg')) return 'negative';
            if (normalized.includes('neu')) return 'neutral';
            return 'neutral';
        }

        function getBadgeClass(sentiment) {
            if (sentiment === 'positive') return 'badge-positive';
            if (sentiment === 'negative') return 'badge-negative';
            return 'badge-neutral';
        }

        function clampConfidence(value) {
            const numeric = Number(value);
            return Number.isNaN(numeric) ? 0 : Math.max(0, Math.min(1, numeric));
        }

        function formatConfidence(value) {
            return (clampConfidence(value) * 100).toFixed(1);
        }

        // --- Single Analysis ---
        async function analyzeSingle() {
            const text = document.getElementById('singleText').value.trim();
            const model = document.getElementById('singleModel').value;
            const resultDiv = document.getElementById('singleResult');

            if (!text) {
                resultDiv.innerHTML = `<div class="status-msg status-error">‚ö†Ô∏è Please enter some text first!</div>`;
                return;
            }

            resultDiv.innerHTML = `<div class="status-msg status-loading">‚è≥ Analyzing with AI model...</div>`;

            try {
                const response = await fetch('/predict_ui', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, model })
                });

                const data = await response.json();
                if (!response.ok || data.error) throw new Error(data.error || 'Analysis failed');

                const sentiment = normalizeSentiment(data.sentiment || data.label);
                const confidence = clampConfidence(data.confidence ?? data.score);
                const confidencePct = (confidence * 100).toFixed(1);

                // Render Result Card
                resultDiv.innerHTML = `
                    <div class="result-widget">
                        <div class="glass-card">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="text-secondary text-uppercase small fw-bold">Detected Sentiment</span>
                                <span class="sentiment-badge ${getBadgeClass(sentiment)}">${sentiment}</span>
                            </div>
                            
                            <div class="mb-1 d-flex justify-content-between text-muted small">
                                <span>Confidence Score</span>
                                <span class="text-white fw-bold">${confidencePct}%</span>
                            </div>
                            <div class="confidence-track">
                                <div class="confidence-progress" style="width: ${confidencePct}%"></div>
                            </div>
                            <div class="mt-3 pt-3 border-top border-secondary border-opacity-25 text-end">
                                <small class="text-secondary">Model: <span class="text-info">${escapeHtml(data.model)}</span></small>
                            </div>
                        </div>
                    </div>
                `;

            } catch (error) {
                resultDiv.innerHTML = `<div class="status-msg status-error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // --- Batch Analysis ---
        async function analyzeBatch(event) {
            event.preventDefault();
            const fileInput = document.getElementById('csvFile');
            const model = document.getElementById('batchModel').value;
            const resultDiv = document.getElementById('batchResult');
            const file = fileInput.files[0];

            if (!file) {
                resultDiv.innerHTML = `<div class="status-msg status-error">üìÇ Please select a CSV file.</div>`;
                return;
            }

            resultDiv.innerHTML = `<div class="status-msg status-loading">Processing dataset... this may take a moment.</div>`;

            const formData = new FormData();
            formData.append('file', file);
            formData.append('model', model);

            try {
                const response = await fetch('/batch_predict_ui', { method: 'POST', body: formData });
                const data = await response.json();

                if (!response.ok || data.error) throw new Error(data.error || 'Batch processing failed');

                renderBatchResults(data);

            } catch (error) {
                resultDiv.innerHTML = `<div class="status-msg status-error">‚ùå Error: ${error.message}</div>`;
            }
        }

        function renderBatchResults(rows) {
            latestBatchRows = rows;
            const cleanRows = rows.map(r => ({
                text: r.text || '',
                sentiment: normalizeSentiment(r.sentiment || r.label),
                confidence: clampConfidence(r.confidence ?? r.score)
            }));

            // Calculate Stats
            const counts = { positive: 0, negative: 0, neutral: 0 };
            let totalConf = 0;
            cleanRows.forEach(r => {
                counts[r.sentiment]++;
                totalConf += r.confidence;
            });

            const total = cleanRows.length || 1;
            const stats = {
                pos: ((counts.positive / total) * 100).toFixed(1),
                neg: ((counts.negative / total) * 100).toFixed(1),
                neu: ((counts.neutral / total) * 100).toFixed(1),
                avgConf: ((totalConf / total) * 100).toFixed(1)
            };

            const resultDiv = document.getElementById('batchResult');
            resultDiv.innerHTML = `
                <div class="result-widget">
                    <!-- Summary Stats -->
                    <div class="row g-2 mb-3 text-center">
                        <div class="col-4">
                            <div class="glass-card p-2">
                                <div class="h5 mb-0 text-success">${counts.positive}</div>
                                <small class="text-secondary" style="font-size:0.7rem">POS</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="glass-card p-2">
                                <div class="h5 mb-0 text-danger">${counts.negative}</div>
                                <small class="text-secondary" style="font-size:0.7rem">NEG</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="glass-card p-2">
                                <div class="h5 mb-0 text-warning">${counts.neutral}</div>
                                <small class="text-secondary" style="font-size:0.7rem">NEU</small>
                            </div>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="progress bg-dark mb-3" style="height: 6px;">
                        <div class="progress-bar bg-success" style="width: ${stats.pos}%"></div>
                        <div class="progress-bar bg-danger" style="width: ${stats.neg}%"></div>
                        <div class="progress-bar bg-warning" style="width: ${stats.neu}%"></div>
                    </div>

                    <!-- Chart Canvas -->
                    <div class="mb-3" style="height: 200px;">
                        <canvas id="batchChartCanvas"></canvas>
                    </div>

                <!-- Action Buttons -->
                    <div class="d-grid gap-2 mb-4">
                        <button onclick="downloadBatchCsv()" class="btn-secondary-glass w-100">
                            üì• Download Full Report (.csv)
                        </button>
                    </div>

                    <!-- Detailed Table -->
                    <div class="glass-card p-0 overflow-hidden">
                        <div class="p-3 border-bottom border-secondary border-opacity-25 bg-black bg-opacity-25">
                            <h3 class="h6 mb-0 text-white">Analysis Details</h3>
                        </div>
                        <div class="table-responsive" style="max-height: 400px;">
                            <table class="table table-borderless table-hover align-middle mb-0" style="--bs-table-bg: transparent; --bs-table-hover-bg: rgba(255,255,255,0.05); color: var(--text-primary);">
                                <thead style="background: rgba(0,0,0,0.3); backdrop-filter: blur(4px);">
                                    <tr>
                                        <th class="ps-3 text-secondary" style="width: 50px;">#</th>
                                        <th class="text-secondary">Text Content</th>
                                        <th class="text-secondary" style="width: 140px;">Sentiment</th>
                                        <th class="text-secondary text-end pe-3" style="width: 120px;">Score</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${cleanRows.map((row, i) => `
                                    <tr>
                                        <td class="ps-3 text-muted small">${i + 1}</td>
                                        <td class="text-opacity-75" style="max-width: 300px; word-break: break-word;">
                                            ${escapeHtml(row.text)}
                                        </td>
                                        <td>
                                            <span class="sentiment-badge ${getBadgeClass(row.sentiment)}" style="font-size: 0.75rem; padding: 0.3em 0.8em;">
                                                ${row.sentiment}
                                            </span>
                                        </td>
                                        <td class="text-end pe-3">
                                            <div class="d-flex align-items-center justify-content-end gap-2">
                                                <small class="text-white fw-bold">${(row.confidence * 100).toFixed(0)}%</small>
                                                <div style="width: 40px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px;">
                                                    <div style="width: ${row.confidence * 100}%; height: 100%; background: var(--accent-primary); border-radius: 2px;"></div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            // Render Chart
            renderChart(counts);
        }

        function renderChart(counts) {
            const ctx = document.getElementById('batchChartCanvas');
            if (batchChart) batchChart.destroy();

            batchChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Positive', 'Negative', 'Neutral'],
                    datasets: [{
                        data: [counts.positive, counts.negative, counts.neutral],
                        backgroundColor: ['#4ade80', '#f87171', '#fbbf24'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: '#94a3b8', font: { family: 'Outfit' } } }
                    },
                    cutout: '70%'
                }
            });
        }

        function downloadBatchCsv() {
            if (!latestBatchRows.length) return;
            const headers = ['text', 'label', 'score'];
            const lines = [headers.join(',')];
            latestBatchRows.forEach(row => {
                const text = `"${String(row.text).replace(/"/g, '""')}"`;
                const label = row.sentiment || row.label;
                const score = row.confidence ?? row.score;
                lines.push([text, label, score].join(','));
            });

            const blob = new Blob([lines.join('\n')], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sentiment_results.csv';
            a.click();
        }
    </script>
</body>

</html>