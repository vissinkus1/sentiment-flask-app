<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentiment Studio</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
</head>

<body>
    <div class="bg-orb orb-a" aria-hidden="true"></div>
    <div class="bg-orb orb-b" aria-hidden="true"></div>

    <main class="container app-shell py-4 py-lg-5">
        <section class="hero-panel mb-4 mb-lg-5">
            <p class="eyebrow mb-2">NLP Sentiment Toolkit</p>
            <h1 class="hero-title mb-3">Sentiment Studio</h1>
            <p class="hero-copy mb-0">
                Analyze single text or CSV datasets using BERT, VADER, and TextBlob.
            </p>
        </section>

        <div class="row g-4">
            <!-- SINGLE TEXT -->
            <section class="col-lg-6">
                <div class="panel h-100">
                    <div class="panel-header mb-3">
                        <h2 class="panel-title">Single Text Analysis</h2>
                        <p class="panel-subtitle mb-0">Analyze a sentence instantly.</p>
                    </div>

                    <label for="singleText" class="input-label">Input Text</label>
                    <textarea id="singleText" class="text-input" rows="5"
                        placeholder="Example: I really enjoyed this product."></textarea>

                    <div class="row g-3 mt-1">
                        <div class="col-sm-7">
                            <label for="singleModel" class="input-label">Model</label>
                            <select class="model-select" id="singleModel">
                                <option value="bert">BERT</option>
                                <option value="vader">VADER</option>
                                <option value="textblob">TextBlob</option>
                            </select>
                        </div>
                        <div class="col-sm-5 d-grid align-self-end">
                            <button class="btn-action" type="button" onclick="analyzeSingle()">
                                Analyze Text
                            </button>
                        </div>
                    </div>

                    <p class="hint mt-2 mb-0">
                        Note: First BERT request may take 10–15 seconds on cloud servers.
                    </p>

                    <div id="singleResult" class="result-zone mt-3"></div>
                </div>
            </section>

            <!-- BATCH CSV -->
            <section class="col-lg-6">
                <div class="panel h-100">
                    <div class="panel-header mb-3">
                        <h2 class="panel-title">Batch CSV Analysis</h2>
                        <p class="panel-subtitle mb-0">CSV must contain a <code>text</code> column.</p>
                    </div>

                    <form id="batchForm" onsubmit="analyzeBatch(event)">
                        <label for="csvFile" class="input-label">CSV File</label>
                        <input type="file" id="csvFile" accept=".csv" class="file-input" required>

                        <div class="row g-3 mt-1">
                            <div class="col-sm-7">
                                <label for="batchModel" class="input-label">Model</label>
                                <select class="model-select" id="batchModel">
                                    <option value="bert">BERT</option>
                                    <option value="vader">VADER</option>
                                    <option value="textblob">TextBlob</option>
                                </select>
                            </div>
                            <div class="col-sm-5 d-grid align-self-end">
                                <button class="btn-action" type="submit">Analyze CSV</button>
                            </div>
                        </div>
                    </form>

                    <p class="hint mt-3 mb-0">
                        Tip: On free tier, BERT is limited to small CSV files.
                    </p>

                    <div id="batchResult" class="result-zone mt-3"></div>
                </div>
            </section>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>

    <script>
        function escapeHtml(v) {
            return String(v).replace(/&/g, "&amp;")
                            .replace(/</g, "&lt;")
                            .replace(/>/g, "&gt;");
        }

        function showStatus(id, msg, type) {
            document.getElementById(id).innerHTML =
                `<div class="result-box ${type}">${escapeHtml(msg)}</div>`;
        }

        function normalizeSentiment(v) {
            v = String(v).toLowerCase();
            if (v.includes("pos")) return "positive";
            if (v.includes("neg")) return "negative";
            return "neutral";
        }

        function sentimentClass(s) {
            return s === "positive" ? "sentiment-positive" :
                   s === "negative" ? "sentiment-negative" :
                   "sentiment-neutral";
        }

        function formatConfidence(v) {
            return (Math.max(0, Math.min(1, Number(v))) * 100).toFixed(1);
        }

        function renderSingleResult(r) {
            const s = normalizeSentiment(r.sentiment);
            const c = formatConfidence(r.confidence);
            document.getElementById("singleResult").innerHTML = `
                <div class="result-box">
                    <p><strong>Model:</strong> ${escapeHtml(r.model)}</p>
                    <p><strong>Sentiment:</strong>
                        <span class="sentiment-pill ${sentimentClass(s)}">${s.toUpperCase()}</span>
                    </p>
                    <p><strong>Confidence:</strong> ${c}%</p>
                </div>`;
        }

        async function analyzeSingle() {
            const text = document.getElementById("singleText").value.trim();
            const model = document.getElementById("singleModel").value;

            if (!text) {
                showStatus("singleResult", "Please enter text.", "is-error");
                return;
            }

            showStatus("singleResult", "Analyzing...", "is-loading");

            const res = await fetch("/predict_ui", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text, model })
            });

            const data = await res.json();

            if (!res.ok || data.sentiment === "unsupported_model") {
                showStatus("singleResult",
                    "BERT unavailable. Please use VADER or TextBlob.", "is-error");
                return;
            }

            renderSingleResult(data);
        }

        async function analyzeBatch(e) {
            e.preventDefault();

            const file = document.getElementById("csvFile").files[0];
            const model = document.getElementById("batchModel").value;

            if (model === "bert" && file.size > 1024 * 1024) {
                showStatus("batchResult",
                    "BERT batch is limited on free tier. Use smaller CSV or VADER.",
                    "is-error");
                return;
            }

            showStatus("batchResult", "Analyzing CSV...", "is-loading");

            const form = new FormData();
            form.append("file", file);
            form.append("model", model);

            const res = await fetch("/batch_predict_ui", { method: "POST", body: form });
            const data = await res.json();

            if (!res.ok || data.error) {
                showStatus("batchResult", data.error || "Batch failed.", "is-error");
                return;
            }

            showStatus("batchResult", "CSV analyzed successfully ✔", "is-success");
        }
    </script>
</body>
</html>
